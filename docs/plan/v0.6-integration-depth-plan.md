# v0.6 Integration Depth Plan

## Goal

Deepen runtime integration across claims, workflow, agent pool, and daemon operations without adding legacy aliases.

## Status Legend

- [ ] pending
- [-] in progress
- [x] done
- [!] blocked

## Validation Gates (per epic)

- `make validate`
- `make selftest`
- `make install-test`
- `pre-commit run --all-files`

## Worklog

| UTC | Epic/Task | Status | Notes |
|---|---|---|---|
| 2026-02-24T07:35:00Z | Plan scaffold created | done | v0.6 epics and sequencing agreed with user. |
| 2026-02-24T08:10:00Z | E1 unified delivery flow | done | Added `/delivery` transaction orchestration with run ledger and doctor support. |
| 2026-02-24T08:16:00Z | E2 workflow reliability depth | done | Added `--execute`, `depends_on` ordering, and guarded command-step execution semantics. |
| 2026-02-24T08:22:00Z | E3 daemon reconciliation + metrics | done | Added `/daemon tick` stale-claim reconciliation and summary integration; claims now report pool load. |
| 2026-02-24T08:24:00Z | Validation gates | done | Passed validate/selftest/install-test/pre-commit for v0.6 scope. |

## Epics

### E1 Unified Delivery Transaction Flow

Objective: one canonical flow to claim work, assign agent capacity, run workflow, and finalize claim state.

- [x] Add `/delivery` command backend with `start|status|handoff|close|doctor`
- [x] Implement transactional orchestration (`claims claim` -> `workflow run` -> `claims release`/handoff)
- [x] Persist run ledger for traceability and recovery
- [x] Add doctor integration and handbook docs
- [x] Add selftest/install coverage

### E2 Workflow Reliability Depth

Objective: robust workflow execution with retry policies, resume support, and conditional steps.

- [x] Add step-level retry policy (`retry`) and attempt counters
- [x] Add conditional execution (`when`: `always|on_success|on_failure`)
- [x] Add `workflow resume --run-id <id>` from last failed step
- [x] Improve run records (attempts, skipped states, ordered deps)
- [x] Add docs + selftest coverage

### E3 Daemon Reconciliation and Metrics

Objective: daemon acts as operational reconciler and trend reporter across runtime subsystems.

- [x] Add daemon reconciliation pass across claims/workflow/agent-pool/hook-learning
- [x] Add daemon metrics snapshots/history based on real subsystem states
- [x] Extend `daemon summary` with trend counters and last reconcile report
- [x] Add docs + selftest coverage

## Execution Order

1. E1 delivery transaction flow
2. E2 workflow reliability depth
3. E3 daemon reconciliation and metrics

## Handoff Notes

- Keep canonical command philosophy; no legacy alias restoration.
- Update these surfaces whenever behavior changes:
  - `opencode.json`
  - `docs/command-handbook.md`
  - `scripts/doctor_command.py` (if diagnosable)
  - `scripts/selftest.py`
- Keep commits small per epic and run full validation gates after each epic.
